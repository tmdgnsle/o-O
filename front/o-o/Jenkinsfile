pipeline {
  agent any

  environment {
    // ====== 필수 값 바꿔 넣기 ======
    AWS_REGION = 'ap-northeast-2'
    S3_BUCKET  = 'o-o-frontend'       // ex) myapp-frontend-prod
    CF_DIST_ID = 'E15YK94HXRWQA2'     // ex) E1ABCDEF123456
    BUILD_DIR  = 'dist'              // React=build, Vite/Next=dist
    NODE_OPTIONS = '--max-old-space-size=2048'
  }

  options {
    timestamps()
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        sh 'echo "Branch: ${BRANCH_NAME}"'
      }
    }

    stage('Install & Build') {
      steps {
        dir('front/o-o') {
          sh '''
            echo "=== Node & npm Version ==="
            node -v
            npm -v

            echo "=== Install & Build ==="
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi
            npm run build
          '''
        }
      }
    }

    stage('Upload to S3') {
      steps {
        withAWS(credentials: 'aws-frontend-deploy', region: "${AWS_REGION}") {
          sh """
            echo "=== Upload static assets to S3 ==="
            aws s3 sync front/o-o/${BUILD_DIR} s3://${S3_BUCKET} \
              --delete \
              --exclude "index.html" \
              --cache-control "public,max-age=31536000,immutable"

            echo "=== Upload index.html (no-cache) ==="
            aws s3 cp front/o-o/${BUILD_DIR}/index.html s3://${S3_BUCKET}/index.html \
              --cache-control "no-cache,no-store,must-revalidate" \
              --metadata-directive REPLACE \
              --content-type "text/html; charset=utf-8"
          """
        }
      }
    }

    stage('CloudFront Invalidation') {
      steps {
        withAWS(credentials: 'aws-frontend-deploy', region: "${AWS_REGION}") {
          sh '''
            echo "=== Invalidate CloudFront Cache ==="
            aws cloudfront create-invalidation \
              --distribution-id ${CF_DIST_ID} \
              --paths "/*"
          '''
        }
      }
    }
  }

  post {
    success {
      echo 'Deploy done: S3 upload + CloudFront invalidation completed.'
    }
    failure {
      echo 'Deploy failed. Check console log.'
    }
    always {
      cleanWs(deleteDirs: true, notFailBuild: true)
    }
  }
}
