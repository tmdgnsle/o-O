<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text to MindMap - Streaming Test</title>
    <!-- D3.js for mindmap -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 14px;
      }

      .content {
        padding: 30px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .input-group textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        min-height: 120px;
        transition: all 0.3s;
      }

      .input-group textarea:focus {
        outline: none;
        border-color: #11998e;
        box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
      }

      .input-group select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 14px;
        background-color: white;
        cursor: pointer;
        transition: all 0.3s;
      }

      .input-group select:focus {
        outline: none;
        border-color: #11998e;
        box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
      }

      .btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(17, 153, 142, 0.3);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .example-prompts {
        margin-top: 10px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .example-prompts h4 {
        margin-bottom: 10px;
        color: #11998e;
        font-size: 14px;
      }

      .example-prompt {
        display: inline-block;
        padding: 6px 12px;
        margin: 4px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .example-prompt:hover {
        background: #11998e;
        color: white;
        border-color: #11998e;
      }

      .progress-section {
        margin-top: 30px;
        display: none;
      }

      .progress-section.active {
        display: block;
      }

      .progress-bar-container {
        background: #f0f0f0;
        border-radius: 10px;
        height: 30px;
        overflow: hidden;
        margin-bottom: 15px;
        position: relative;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 12px;
      }

      .status-message {
        padding: 12px 16px;
        background: #f8f9fa;
        border-left: 4px solid #11998e;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
        color: #333;
      }

      .log-container {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
        border-radius: 10px;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
        margin-top: 15px;
      }

      .log-entry {
        padding: 4px 0;
        border-bottom: 1px solid #333;
      }

      .log-entry:last-child {
        border-bottom: none;
      }

      .result-section {
        margin-top: 30px;
        display: none;
      }

      .result-section.active {
        display: block;
      }

      .result-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 15px;
      }

      .result-card h3 {
        color: #11998e;
        margin-bottom: 12px;
        font-size: 18px;
      }

      .error {
        background: #fee;
        border-left-color: #f44336;
        color: #c62828;
      }

      /* ë§ˆì¸ë“œë§µ ìŠ¤íƒ€ì¼ */
      #mindmapContainer {
        width: 100%;
        height: 700px;
        background: white;
        border-radius: 10px;
        border: 2px solid #e0e0e0;
        overflow: hidden;
        position: relative;
      }

      #mindmapSvg {
        width: 100%;
        height: 100%;
        cursor: grab;
      }

      #mindmapSvg:active {
        cursor: grabbing;
      }

      .node-rect {
        fill: white;
        stroke: #11998e;
        stroke-width: 2;
        rx: 8;
        ry: 8;
      }

      .node-rect.root {
        fill: #11998e;
      }

      .node-keyword {
        font-weight: 600;
        fill: #333;
        pointer-events: none;
      }

      .node-keyword.root {
        fill: white;
      }

      .node-description {
        font-size: 10px;
        fill: #666;
        pointer-events: none;
      }

      .node-description.root {
        fill: rgba(255, 255, 255, 0.9);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ’¡ Text to MindMap</h1>
        <p>AI-Powered MindMap Generation</p>
      </div>

      <div class="content">
        <div class="input-group">
          <label for="textPrompt">í…ìŠ¤íŠ¸ / ì£¼ì œ</label>
          <textarea
            id="textPrompt"
            placeholder="ë¶„ì„í•  ì£¼ì œë‚˜ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: ì¸ê³µì§€ëŠ¥ì˜ ì—­ì‚¬ì™€ ë°œì „ ê³¼ì •"
          ></textarea>
          <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
            ì£¼ì œ, ê°œë…, ì§ˆë¬¸ ë“± ì–´ë–¤ í…ìŠ¤íŠ¸ë“  ì…ë ¥í•˜ë©´ AIê°€ ë§ˆì¸ë“œë§µìœ¼ë¡œ êµ¬ì¡°í™”í•©ë‹ˆë‹¤.
          </small>
        </div>

        <div class="example-prompts">
          <h4>ğŸ“Œ ì˜ˆì‹œ í”„ë¡¬í”„íŠ¸ (í´ë¦­í•˜ì—¬ ì…ë ¥)</h4>
          <span class="example-prompt" onclick="setPrompt('ì¸ê³µì§€ëŠ¥ì˜ ì—­ì‚¬ì™€ ì£¼ìš” ë°œì „ ë‹¨ê³„')">
            ì¸ê³µì§€ëŠ¥ì˜ ì—­ì‚¬
          </span>
          <span class="example-prompt" onclick="setPrompt('ë¸”ë¡ì²´ì¸ ê¸°ìˆ ì˜ ì›ë¦¬ì™€ ì‘ìš© ë¶„ì•¼')">
            ë¸”ë¡ì²´ì¸ ê¸°ìˆ 
          </span>
          <span class="example-prompt" onclick="setPrompt('ê¸°í›„ ë³€í™”ì˜ ì›ì¸, ì˜í–¥, í•´ê²° ë°©ì•ˆ')">
            ê¸°í›„ ë³€í™”
          </span>
          <span class="example-prompt" onclick="setPrompt('íš¨ê³¼ì ì¸ ì‹œê°„ ê´€ë¦¬ ë°©ë²•ê³¼ ìƒì‚°ì„± í–¥ìƒ ì „ëµ')">
            ì‹œê°„ ê´€ë¦¬
          </span>
          <span class="example-prompt" onclick="setPrompt('ë¨¸ì‹ ëŸ¬ë‹ê³¼ ë”¥ëŸ¬ë‹ì˜ ì°¨ì´ì ê³¼ í™œìš© ì‚¬ë¡€')">
            ML vs DL
          </span>
          <span class="example-prompt" onclick="setPrompt('ìŠ¤íƒ€íŠ¸ì—… ì°½ì—… ê³¼ì •: ì•„ì´ë””ì–´ë¶€í„° íˆ¬ì ìœ ì¹˜ê¹Œì§€')">
            ìŠ¤íƒ€íŠ¸ì—… ì°½ì—…
          </span>
        </div>

        <div class="input-group" style="margin-top: 20px">
          <label for="detailLevel">ìƒì„¸ ìˆ˜ì¤€</label>
          <select id="detailLevel">
            <option value="simple">Simple - ê°„ë‹¨í•˜ê²Œ (2ë‹¨ê³„, ~5-10ì´ˆ)</option>
            <option value="medium" selected>Medium - ì ì ˆí•˜ê²Œ (3-4ë‹¨ê³„, ~10-20ì´ˆ)</option>
            <option value="detailed">Detailed - ìƒì„¸í•˜ê²Œ (4-5ë‹¨ê³„, ~15-30ì´ˆ)</option>
          </select>
          <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
            ìƒì„¸ ìˆ˜ì¤€ì´ ë†’ì„ìˆ˜ë¡ ë§ˆì¸ë“œë§µì´ ê¹Šê³  ìì„¸í•´ì§‘ë‹ˆë‹¤.
          </small>
        </div>

        <button class="btn" id="analyzeBtn" onclick="startAnalysis()">
          ğŸš€ Generate MindMap
        </button>

        <div class="progress-section" id="progressSection">
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar">0%</div>
          </div>
          <div class="status-message" id="statusMessage">ì¤€ë¹„ ì¤‘...</div>

          <details>
            <summary style="cursor: pointer; margin-bottom: 10px; font-weight: 600">
              ğŸ“‹ View Logs
            </summary>
            <div class="log-container" id="logContainer"></div>
          </details>
        </div>

        <div class="result-section" id="resultSection">
          <div class="result-card">
            <h3>ğŸ—ºï¸ Mind Map</h3>
            <div id="mindmapContainer">
              <svg id="mindmapSvg"></svg>
            </div>
            <div style="margin-top: 15px; text-align: center; color: #666; font-size: 12px;">
              ğŸ’¡ Tip: ë“œë˜ê·¸ë¡œ ì´ë™, ìŠ¤í¬ë¡¤ë¡œ í™•ëŒ€/ì¶•ì†Œ
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function setPrompt(text) {
        document.getElementById("textPrompt").value = text;
      }

      function renderMindMap(mindmapData) {
        if (!mindmapData) return;

        function convertToD3Hierarchy(node) {
          const d3Node = {
            name: node.keyword,
            description: node.description,
          };

          if (node.children && node.children.length > 0) {
            d3Node.children = node.children.map((child) =>
              convertToD3Hierarchy(child)
            );
          }

          return d3Node;
        }

        const hierarchyData = convertToD3Hierarchy(mindmapData);

        const svg = document.getElementById("mindmapSvg");
        const container = document.getElementById("mindmapContainer");
        svg.innerHTML = "";

        const width = container.clientWidth;
        const height = container.clientHeight;

        const root = d3.hierarchy(hierarchyData);

        const nodeCount = root.descendants().length;
        const treeHeight = Math.max(height * 3, nodeCount * 200);
        const treeWidth = Math.max(width * 3, root.height * 600);

        const treeLayout = d3
          .tree()
          .size([treeHeight, treeWidth])
          .nodeSize([150, 300]);

        treeLayout(root);

        const svgElement = d3.select(svg).attr("width", width).attr("height", height);

        const zoom = d3
          .zoom()
          .scaleExtent([0.1, 3])
          .on("zoom", (event) => {
            g.attr("transform", event.transform);
          });

        svgElement.call(zoom);

        const g = svgElement.append("g").attr("transform", "translate(250, 150)");

        g.selectAll(".link")
          .data(root.links())
          .enter()
          .append("path")
          .attr("class", "link")
          .attr("fill", "none")
          .attr("stroke", "#11998e")
          .attr("stroke-width", 2)
          .attr(
            "d",
            d3
              .linkHorizontal()
              .x((d) => d.y)
              .y((d) => d.x)
          );

        const nodes = g
          .selectAll(".node")
          .data(root.descendants())
          .enter()
          .append("g")
          .attr("class", "node")
          .attr("transform", (d) => `translate(${d.y},${d.x})`);

        nodes.each(function (d) {
          const isRoot = d.depth === 0;
          const keyword = d.data.name;
          const description = d.data.description || "";

          const descLines = [];
          if (description) {
            const maxCharsPerLine = 25;
            for (let i = 0; i < description.length; i += maxCharsPerLine) {
              descLines.push(description.substring(i, i + maxCharsPerLine));
            }
          }

          d.descLines = descLines;
          d.rectWidth = Math.max(
            keyword.length * (isRoot ? 14 : 12) + 40,
            Math.max(...descLines.map((line) => line.length * 7)) + 40,
            isRoot ? 180 : 150
          );
          d.rectHeight = isRoot
            ? 70 + descLines.length * 16
            : 60 + descLines.length * 14;
        });

        nodes
          .append("rect")
          .attr("class", (d) => (d.depth === 0 ? "node-rect root" : "node-rect"))
          .attr("x", (d) => -d.rectWidth / 2)
          .attr("y", (d) => -d.rectHeight / 2)
          .attr("width", (d) => d.rectWidth)
          .attr("height", (d) => d.rectHeight)
          .style("cursor", "pointer");

        nodes
          .append("text")
          .attr("class", (d) => (d.depth === 0 ? "node-keyword root" : "node-keyword"))
          .attr("text-anchor", "middle")
          .attr("dy", (d) => -d.rectHeight / 2 + (d.depth === 0 ? 25 : 20))
          .style("font-size", (d) => (d.depth === 0 ? "14px" : "12px"))
          .text((d) => d.data.name);

        nodes.each(function (d) {
          const node = d3.select(this);
          const isRoot = d.depth === 0;

          d.descLines.forEach((line, i) => {
            node
              .append("text")
              .attr("class", isRoot ? "node-description root" : "node-description")
              .attr("text-anchor", "middle")
              .attr("dy", -d.rectHeight / 2 + (isRoot ? 42 : 35) + i * (isRoot ? 14 : 12))
              .text(line);
          });
        });

        const initialTransform = d3.zoomIdentity
          .translate(width / 2 - 250, height / 2 - 150)
          .scale(0.8);
        svgElement.call(zoom.transform, initialTransform);
      }

      function addLog(message, type = "info") {
        const logContainer = document.getElementById("logContainer");
        const entry = document.createElement("div");
        entry.className = "log-entry";
        const timestamp = new Date().toLocaleTimeString();
        entry.innerHTML = `<span style="color: #888">[${timestamp}]</span> ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      function updateProgress(progress, message) {
        const progressBar = document.getElementById("progressBar");
        const statusMessage = document.getElementById("statusMessage");

        progressBar.style.width = progress + "%";
        progressBar.textContent = progress + "%";
        statusMessage.textContent = message;
        statusMessage.className = "status-message";
      }

      function showError(message) {
        const statusMessage = document.getElementById("statusMessage");
        statusMessage.textContent = "âŒ " + message;
        statusMessage.className = "status-message error";
        addLog(`ERROR: ${message}`, "error");
      }

      function displayResult(result) {
        const resultSection = document.getElementById("resultSection");
        resultSection.classList.add("active");

        if (result.mindmap) {
          renderMindMap(result.mindmap);
        } else {
          console.error("ë§ˆì¸ë“œë§µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!");
        }
      }

      async function startAnalysis() {
        const textPrompt = document.getElementById("textPrompt").value.trim();
        const detailLevel = document.getElementById("detailLevel").value;
        const analyzeBtn = document.getElementById("analyzeBtn");
        const progressSection = document.getElementById("progressSection");
        const resultSection = document.getElementById("resultSection");

        if (!textPrompt) {
          alert("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
          return;
        }

        if (textPrompt.length < 3) {
          alert("ìµœì†Œ 3ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”");
          return;
        }

        // Reset UI
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = "â³ Generating...";
        progressSection.classList.add("active");
        resultSection.classList.remove("active");
        document.getElementById("logContainer").innerHTML = "";
        updateProgress(0, "Connecting...");

        addLog("ë§ˆì¸ë“œë§µ ìƒì„± ì‹œì‘...");
        addLog(`í…ìŠ¤íŠ¸: ${textPrompt.substring(0, 100)}${textPrompt.length > 100 ? '...' : ''}`);
        addLog(`ìƒì„¸ ìˆ˜ì¤€: ${detailLevel}`);

        try {
          const requestBody = {
            text_prompt: textPrompt,
            detail_level: detailLevel,
          };

          const response = await fetch("http://localhost:8000/analyze/text", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while (true) {
            const { done, value } = await reader.read();

            if (done) {
              break;
            }

            buffer += decoder.decode(value, { stream: true });

            const lines = buffer.split("\n");
            buffer = lines.pop() || "";

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                const jsonStr = line.substring(6).trim();
                if (!jsonStr) continue;

                try {
                  const data = JSON.parse(jsonStr);

                  console.log("ğŸ“¥ Server Response:", data);

                  addLog(`[${data.status}] ${data.message || ""}`);

                  if (data.progress !== undefined) {
                    updateProgress(data.progress, data.message || data.status);
                  }

                  if (data.status === "completed" && data.result) {
                    console.log("âœ… Final Result:", data.result);
                    displayResult(data.result);
                    addLog("âœ… ë§ˆì¸ë“œë§µ ìƒì„± ì™„ë£Œ!");
                  } else if (data.status === "failed") {
                    console.error("âŒ Error:", data.error);
                    showError(data.error || "Unknown error");
                  }
                } catch (e) {
                  console.error("Failed to parse JSON:", e, "String:", jsonStr.substring(0, 200));
                }
              }
            }
          }
        } catch (error) {
          showError(error.message);
          console.error("Error:", error);
        } finally {
          analyzeBtn.disabled = false;
          analyzeBtn.textContent = "ğŸš€ Generate MindMap";
        }
      }

      // Allow Ctrl+Enter to submit
      document.getElementById("textPrompt").addEventListener("keydown", function (e) {
        if (e.ctrlKey && e.key === "Enter") {
          startAnalysis();
        }
      });
    </script>
  </body>
</html>
