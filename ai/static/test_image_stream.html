<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Analysis - Streaming Test</title>
    <!-- D3.js for mindmap -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 14px;
      }

      .content {
        padding: 30px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .input-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .progress-section {
        margin-top: 30px;
        display: none;
      }

      .progress-section.active {
        display: block;
      }

      .progress-bar-container {
        background: #f0f0f0;
        border-radius: 10px;
        height: 30px;
        overflow: hidden;
        margin-bottom: 15px;
        position: relative;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 12px;
      }

      .status-message {
        padding: 12px 16px;
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
        color: #333;
      }

      .log-container {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
        border-radius: 10px;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
        margin-top: 15px;
      }

      .log-entry {
        padding: 4px 0;
        border-bottom: 1px solid #333;
      }

      .log-entry:last-child {
        border-bottom: none;
      }

      .result-section {
        margin-top: 30px;
        display: none;
      }

      .result-section.active {
        display: block;
      }

      .result-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 15px;
      }

      .result-card h3 {
        color: #667eea;
        margin-bottom: 12px;
        font-size: 18px;
      }

      .result-card p,
      .result-card pre {
        color: #333;
        line-height: 1.6;
        font-size: 14px;
      }

      .result-card pre {
        background: white;
        padding: 15px;
        border-radius: 8px;
        overflow-x: auto;
        white-space: pre-wrap;
      }

      .error {
        background: #fee;
        border-left-color: #f44336;
        color: #c62828;
      }

      /* ì´ë¯¸ì§€ í”„ë¦¬ë·° */
      .image-preview {
        width: 100%;
        max-width: 400px;
        margin: 20px auto;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .image-preview img {
        width: 100%;
        height: auto;
        display: block;
      }

      /* ë§ˆì¸ë“œë§µ ìŠ¤íƒ€ì¼ */
      #mindmapContainer {
        width: 100%;
        height: 600px;
        background: white;
        border-radius: 10px;
        border: 2px solid #e0e0e0;
        overflow: hidden;
        position: relative;
      }

      #mindmapSvg {
        width: 100%;
        height: 100%;
        cursor: grab;
      }

      #mindmapSvg:active {
        cursor: grabbing;
      }

      .node-rect {
        fill: white;
        stroke: #667eea;
        stroke-width: 2;
        rx: 8;
        ry: 8;
      }

      .node-rect.root {
        fill: #764ba2;
      }

      .node-keyword {
        font-weight: 600;
        fill: #333;
        pointer-events: none;
      }

      .node-keyword.root {
        fill: white;
      }

      .node-description {
        font-size: 10px;
        fill: #666;
        pointer-events: none;
      }

      .node-description.root {
        fill: rgba(255, 255, 255, 0.9);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ–¼ï¸ Image Analysis</h1>
        <p>Real-time Streaming API Test</p>
      </div>

      <div class="content">
        <div class="input-group">
          <label for="imageUrl">Image URL</label>
          <input
            type="text"
            id="imageUrl"
            placeholder="https://example.com/image.jpg"
            value="https://picsum.photos/800/600"
          />
          <small
            style="
              color: #666;
              font-size: 12px;
              margin-top: 5px;
              display: block;
            "
          >
            ë¶„ì„í•  ì´ë¯¸ì§€ì˜ URLì„ ì…ë ¥í•˜ì„¸ìš”
          </small>
        </div>

        <div class="input-group">
          <label for="userPrompt">User Prompt (Optional)</label>
          <input
            type="text"
            id="userPrompt"
            placeholder="ì˜ˆ: ì´ ì´ë¯¸ì§€ì—ì„œ ì£¼ìš” ê°ì²´ë“¤ì„ ì°¾ì•„ì„œ ì„¤ëª…í•´ì£¼ì„¸ìš”"
          />
          <small
            style="
              color: #666;
              font-size: 12px;
              margin-top: 5px;
              display: block;
            "
          >
            ì´ë¯¸ì§€ ë¶„ì„ ì‹œ íŠ¹ë³„íˆ ì£¼ëª©í•  ì ì´ë‚˜ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”
          </small>
        </div>

        <button class="btn" id="analyzeBtn" onclick="startAnalysis()">
          ğŸš€ Start Analysis
        </button>

        <div class="progress-section" id="progressSection">
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar">0%</div>
          </div>
          <div class="status-message" id="statusMessage">ì¤€ë¹„ ì¤‘...</div>

          <details>
            <summary
              style="cursor: pointer; margin-bottom: 10px; font-weight: 600"
            >
              ğŸ“‹ View Logs
            </summary>
            <div class="log-container" id="logContainer"></div>
          </details>
        </div>

        <div class="result-section" id="resultSection">
          <div class="result-card">
            <h3>ğŸ–¼ï¸ Image Preview</h3>
            <div class="image-preview" id="imagePreview">
              <img id="previewImg" src="" alt="Analyzed Image" />
            </div>
          </div>

          <div class="result-card">
            <h3>ğŸ—ºï¸ Mind Map</h3>
            <div id="mindmapContainer">
              <svg id="mindmapSvg"></svg>
            </div>
          </div>

          <div class="result-card">
            <h3>ğŸ“Š Image Info</h3>
            <p id="imageInfo"></p>
          </div>

          <div class="result-card">
            <h3>ğŸ” Analysis Result</h3>
            <pre id="analysisResult"></pre>
          </div>
        </div>
      </div>
    </div>

    <script>
      function renderMindMap(mindmapData) {
        if (!mindmapData) return;

        // MindMapNodeë¥¼ D3 ê³„ì¸µ êµ¬ì¡°ë¡œ ë³€í™˜
        function convertToD3Hierarchy(node) {
          const d3Node = {
            name: node.keyword,
            description: node.description,
          };

          if (node.children && node.children.length > 0) {
            d3Node.children = node.children.map((child) =>
              convertToD3Hierarchy(child)
            );
          }

          return d3Node;
        }

        const hierarchyData = convertToD3Hierarchy(mindmapData);

        // SVG ì´ˆê¸°í™”
        const svg = document.getElementById("mindmapSvg");
        const container = document.getElementById("mindmapContainer");
        svg.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì œê±°

        const width = container.clientWidth;
        const height = container.clientHeight;

        // D3 ê³„ì¸µ êµ¬ì¡° ìƒì„±
        const root = d3.hierarchy(hierarchyData);

        // íŠ¸ë¦¬ì˜ ì „ì²´ í¬ê¸°ë¥¼ ê³„ì‚° (ë…¸ë“œ ê°œìˆ˜ ê¸°ë°˜)
        const nodeCount = root.descendants().length;
        const treeHeight = Math.max(height * 3, nodeCount * 200);
        const treeWidth = Math.max(width * 3, root.height * 600);

        // íŠ¸ë¦¬ ë ˆì´ì•„ì›ƒ ìƒì„± (ë„“ì€ ê³µê°„ í™•ë³´)
        const treeLayout = d3
          .tree()
          .size([treeHeight, treeWidth])
          .nodeSize([150, 300]);

        treeLayout(root);

        // SVG ì„¤ì •
        const svgElement = d3
          .select(svg)
          .attr("width", width)
          .attr("height", height);

        // ì¤Œ ë° íŒ¬ ê¸°ëŠ¥ ì¶”ê°€
        const zoom = d3
          .zoom()
          .scaleExtent([0.1, 3]) // ìµœì†Œ 10%, ìµœëŒ€ 300% ì¤Œ
          .on("zoom", (event) => {
            g.attr("transform", event.transform);
          });

        svgElement.call(zoom);

        // SVG ê·¸ë£¹ ìƒì„±
        const g = svgElement
          .append("g")
          .attr("transform", "translate(250, 150)");

        // ë§í¬ ê·¸ë¦¬ê¸°
        g.selectAll(".link")
          .data(root.links())
          .enter()
          .append("path")
          .attr("class", "link")
          .attr("fill", "none")
          .attr("stroke", "#667eea")
          .attr("stroke-width", 2)
          .attr(
            "d",
            d3
              .linkHorizontal()
              .x((d) => d.y)
              .y((d) => d.x)
          );

        // ë…¸ë“œ ê·¸ë£¹ ìƒì„±
        const nodes = g
          .selectAll(".node")
          .data(root.descendants())
          .enter()
          .append("g")
          .attr("class", "node")
          .attr("transform", (d) => `translate(${d.y},${d.x})`);

        // ê° ë…¸ë“œì˜ í…ìŠ¤íŠ¸ í¬ê¸° ê³„ì‚°
        nodes.each(function (d) {
          const isRoot = d.depth === 0;
          const keyword = d.data.name;
          const description = d.data.description || "";

          // í…ìŠ¤íŠ¸ ê¸¸ì´ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ê°í˜• í¬ê¸° ê³„ì‚°
          const keywordLength = keyword.length;
          const descLength = description.length;

          // ì„¤ëª…ì„ ì—¬ëŸ¬ ì¤„ë¡œ ë¶„í•  (30ìë§ˆë‹¤)
          const descLines = [];
          if (description) {
            const maxCharsPerLine = 25;
            for (let i = 0; i < descLength; i += maxCharsPerLine) {
              descLines.push(description.substring(i, i + maxCharsPerLine));
            }
          }

          d.descLines = descLines;
          d.rectWidth = Math.max(
            keywordLength * (isRoot ? 14 : 12) + 40,
            Math.max(...descLines.map((line) => line.length * 7)) + 40,
            isRoot ? 180 : 150
          );
          d.rectHeight = isRoot
            ? 70 + descLines.length * 16
            : 60 + descLines.length * 14;
        });

        // ë…¸ë“œ ì‚¬ê°í˜• ê·¸ë¦¬ê¸°
        nodes
          .append("rect")
          .attr("class", (d) =>
            d.depth === 0 ? "node-rect root" : "node-rect"
          )
          .attr("x", (d) => -d.rectWidth / 2)
          .attr("y", (d) => -d.rectHeight / 2)
          .attr("width", (d) => d.rectWidth)
          .attr("height", (d) => d.rectHeight)
          .style("cursor", "pointer");

        // í‚¤ì›Œë“œ í…ìŠ¤íŠ¸ ì¶”ê°€
        nodes
          .append("text")
          .attr("class", (d) =>
            d.depth === 0 ? "node-keyword root" : "node-keyword"
          )
          .attr("text-anchor", "middle")
          .attr("dy", (d) => -d.rectHeight / 2 + (d.depth === 0 ? 25 : 20))
          .style("font-size", (d) => (d.depth === 0 ? "14px" : "12px"))
          .text((d) => d.data.name);

        // ì„¤ëª… í…ìŠ¤íŠ¸ ì¶”ê°€ (ì—¬ëŸ¬ ì¤„)
        nodes.each(function (d) {
          const node = d3.select(this);
          const isRoot = d.depth === 0;

          d.descLines.forEach((line, i) => {
            node
              .append("text")
              .attr(
                "class",
                isRoot ? "node-description root" : "node-description"
              )
              .attr("text-anchor", "middle")
              .attr(
                "dy",
                -d.rectHeight / 2 + (isRoot ? 42 : 35) + i * (isRoot ? 14 : 12)
              )
              .text(line);
          });
        });

        // ì´ˆê¸° ì¤Œì„ ì¤‘ì•™ì— ë§ì¶”ê¸°
        const initialTransform = d3.zoomIdentity
          .translate(width / 2 - 250, height / 2 - 150)
          .scale(0.8);
        svgElement.call(zoom.transform, initialTransform);
      }

      function addLog(message, type = "info") {
        const logContainer = document.getElementById("logContainer");
        const entry = document.createElement("div");
        entry.className = "log-entry";
        const timestamp = new Date().toLocaleTimeString();
        entry.innerHTML = `<span style="color: #888">[${timestamp}]</span> ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      function updateProgress(progress, message) {
        const progressBar = document.getElementById("progressBar");
        const statusMessage = document.getElementById("statusMessage");

        progressBar.style.width = progress + "%";
        progressBar.textContent = progress + "%";
        statusMessage.textContent = message;
        statusMessage.className = "status-message";
      }

      function showError(message) {
        const statusMessage = document.getElementById("statusMessage");
        statusMessage.textContent = "âŒ " + message;
        statusMessage.className = "status-message error";
        addLog(`ERROR: ${message}`, "error");
      }

      function displayResult(result) {
        const resultSection = document.getElementById("resultSection");
        resultSection.classList.add("active");

        // Image Preview
        document.getElementById("previewImg").src = result.image_url;

        // Mind Map
        if (result.mindmap) {
          renderMindMap(result.mindmap);
        } else {
          console.error("ë§ˆì¸ë“œë§µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!");
        }

        // Image Info
        if (result.image_info) {
          document.getElementById("imageInfo").innerHTML = `
                    <strong>Format:</strong> ${result.image_info.format}<br>
                    <strong>Size:</strong> ${result.image_info.width} x ${result.image_info.height}<br>
                    <strong>Mode:</strong> ${result.image_info.mode}
                `;
        }

        // Analysis Result
        if (result.analysis) {
          document.getElementById("analysisResult").textContent =
            result.analysis;
        }
      }

      async function startAnalysis() {
        const imageUrl = document.getElementById("imageUrl").value.trim();
        const userPrompt = document.getElementById("userPrompt").value.trim();
        const analyzeBtn = document.getElementById("analyzeBtn");
        const progressSection = document.getElementById("progressSection");
        const resultSection = document.getElementById("resultSection");

        if (!imageUrl) {
          alert("Please enter an Image URL");
          return;
        }

        // Reset UI
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = "â³ Analyzing...";
        progressSection.classList.add("active");
        resultSection.classList.remove("active");
        document.getElementById("logContainer").innerHTML = "";
        updateProgress(0, "Connecting...");

        addLog("Starting image analysis...");
        addLog(`URL: ${imageUrl}`);
        if (userPrompt) {
          addLog(`User Prompt: ${userPrompt}`);
        }

        try {
          // Use fetch with streaming
          const requestBody = {
            image_url: imageUrl,
          };

          // user_promptê°€ ìˆìœ¼ë©´ ì¶”ê°€
          if (userPrompt) {
            requestBody.user_prompt = userPrompt;
          }

          const response = await fetch("http://localhost:8000/analyze/image", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = ""; // ë²„í¼ ì¶”ê°€

          while (true) {
            const { done, value } = await reader.read();

            if (done) {
              break;
            }

            // ì²­í¬ë¥¼ ë²„í¼ì— ì¶”ê°€
            buffer += decoder.decode(value, { stream: true });

            // ì™„ì „í•œ ë¼ì¸ë“¤ë§Œ ì²˜ë¦¬
            const lines = buffer.split("\n");

            // ë§ˆì§€ë§‰ ë¶ˆì™„ì „í•œ ë¼ì¸ì€ ë²„í¼ì— ë‚¨ê¹€
            buffer = lines.pop() || "";

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                const jsonStr = line.substring(6).trim();
                if (!jsonStr) continue;

                try {
                  const data = JSON.parse(jsonStr);

                  // ì„œë²„ë¡œë¶€í„° ë°›ì€ ë°ì´í„° consoleì— ì¶œë ¥
                  console.log("ğŸ“¥ Server Response:", data);

                  addLog(`[${data.status}] ${data.message || ""}`);

                  if (data.progress !== undefined) {
                    updateProgress(data.progress, data.message || data.status);
                  }

                  if (data.status === "completed" && data.result) {
                    console.log("âœ… Final Result:", data.result);
                    displayResult(data.result);
                    addLog("âœ… Analysis completed successfully!");
                  } else if (data.status === "failed") {
                    console.error("âŒ Error:", data.error);
                    showError(data.error || "Unknown error");
                  }
                } catch (e) {
                  console.error(
                    "Failed to parse JSON:",
                    e,
                    "String:",
                    jsonStr.substring(0, 200)
                  );
                }
              }
            }
          }
        } catch (error) {
          showError(error.message);
          console.error("Error:", error);
        } finally {
          analyzeBtn.disabled = false;
          analyzeBtn.textContent = "ğŸš€ Start Analysis";
        }
      }

      // Allow Enter key to submit
      document
        .getElementById("imageUrl")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            startAnalysis();
          }
        });
    </script>
  </body>
</html>
