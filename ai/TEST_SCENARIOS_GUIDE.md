# 📋 Organize 기능 테스트 시나리오 가이드

## 🎯 개요

총 **6가지 다양한 시나리오**로 Organize 기능을 테스트할 수 있습니다.
각 시나리오는 서로 다른 상황을 시뮬레이션하며, Before/After 비교가 명확하게 표시됩니다.

---

## 📊 전체 시나리오 요약

| # | 시나리오명 | 노드 수 | 특징 | workspaceId |
|---|-----------|---------|------|-------------|
| 1 | 대규모 AI 프로젝트 | 20개 | 중복 노드 있음, 다양한 타입 | 101 |
| 2 | 개인 학습 계획 | 10개 | 간단한 구조, 명확한 중복 | 102 |
| 3 | 스타트업 전략 | 15개 | 복잡한 계층, 중간 규모 | 200 |
| 4 | **프로젝트 회의록** | **12개** | **극단적 중복 (54% 감소!)** | 103 |
| 5 | 영어 노드 테스트 | 8개 | 영어 전용, 번역 방지 테스트 | 104 |
| 6 | 소규모 노드 | 6개 | 최소 규모, 간단한 병합 | 105 |

---

## 🚀 사용 방법

### 1. 기본 사용 (자동으로 1번 시나리오)
```bash
python test_kafka_organize.py
```

### 2. 특정 시나리오 선택
```bash
# 시나리오 4번 (극단적 중복) 테스트
export TEST_SCENARIO=4
python test_kafka_organize.py

# 또는 한 줄로
TEST_SCENARIO=4 python test_kafka_organize.py
```

### 3. 결과 확인
```bash
python test_kafka_organize_consumer.py
```

---

## 📌 시나리오 상세

### 시나리오 1: 대규모 AI 프로젝트 (20개 노드)

**목적**: 복잡한 프로젝트 구조에서 병합 테스트

**특징**:
- text: 18개, image: 1개, video: 1개
- 중복 노드: "요구사항 분석하기" + "요구사항 수집"
- 중복 노드: "개발 진행" + "개발 작업"
- 루트 노드: "AI 협업 플랫폼 개발 프로젝트"

**예상 결과**:
- 18개 → **약 11-13개로 감소** (30-40%)

**사용 예시**:
```bash
export TEST_SCENARIO=1
python test_kafka_organize.py
```

---

### 시나리오 2: 개인 학습 계획 (10개 노드)

**목적**: 간단한 구조에서 명확한 중복 병합

**특징**:
- text: 9개, image: 1개
- 중복 노드: "Spring Boot" + "스프링 프레임워크"
- 중복 노드: "알고리즘 문제풀이" + "코딩테스트 준비"
- 루트 노드: "2025년 개발자 성장 로드맵"

**예상 결과**:
- 9개 → **약 6-7개로 감소** (20-30%)

---

### 시나리오 3: 스타트업 비즈니스 전략 (15개 노드)

**목적**: 복잡한 비즈니스 구조 테스트

**특징**:
- text: 13개, image: 1개, video: 1개
- 중복 노드: "채용" + "개발자 구인"
- 여러 부서의 전략이 섞여 있음
- 루트 노드: "AI 스타트업 비즈니스 전략 2025"

**예상 결과**:
- 13개 → **약 10-11개로 감소** (15-25%)

---

### 시나리오 4: 프로젝트 회의록 (12개 노드) ⭐ 추천!

**목적**: 극단적 중복 상황 테스트

**특징**:
- text: 11개, image: 1개
- **매우 많은 중복**: 3개 그룹의 중복 노드
  * "UI 개선" + "사용자 경험 향상" + "인터페이스 디자인" (3개)
  * "성능 최적화" + "속도 개선" + "최적화 작업" (3개)
  * "버그 수정" + "오류 해결" + "이슈 픽스" (3개)
- 루트 노드: "2025년 1월 기획 회의"

**실제 결과** (테스트 완료):
- 11개 → **5개로 감소** (**54.5% 감소!**) 🎉

**병합 예시**:
```
BEFORE (11개):
  - UI 개선
  - 사용자 경험 향상
  - 인터페이스 디자인
  - 성능 최적화
  - 속도 개선
  - 최적화 작업
  - 버그 수정
  - 오류 해결
  - 이슈 픽스
  - 테스트 강화

AFTER (5개):
  - UI/UX 개선 (3개 병합)
  - 성능 최적화 (3개 병합)
  - 버그 수정 및 오류 해결 (3개 병합)
  - 테스트 강화
```

**사용 예시**:
```bash
export TEST_SCENARIO=4
python test_kafka_organize.py
```

---

### 시나리오 5: 영어 노드 테스트 (8개 노드)

**목적**: 언어 유지 기능 검증 (영어 → 한국어 번역 방지)

**특징**:
- text: 7개, video: 1개
- **모든 노드가 영어로 작성**
- 중복 노드: "Data Collection" + "Data Gathering"
- 중복 노드: "Model Training" + "Model Development"
- 중복 노드: "Evaluation" + "Testing"
- 루트 노드: "Machine Learning Project"

**예상 결과**:
- 7개 → **약 4-5개로 감소** (30-40%)
- ✅ **영어가 한국어로 번역되지 않음**

**검증 항목**:
- [ ] "Data Collection"이 "데이터 수집"으로 번역되지 않았는지
- [ ] "Model Training"이 "모델 학습"으로 번역되지 않았는지
- [ ] 루트 노드 "Machine Learning Project"가 그대로인지

**사용 예시**:
```bash
export TEST_SCENARIO=5
python test_kafka_organize.py
```

---

### 시나리오 6: 소규모 노드 (6개 노드)

**목적**: 최소 규모에서 병합 동작 확인

**특징**:
- text: 5개, image: 1개
- 중복 노드: "교통편 예약" + "기차표 구입"
- 루트 노드: "주말 여행 계획"

**예상 결과**:
- 5개 → **약 4개로 감소** (20%)

---

## 📊 Before/After 비교 기능

### Producer (전송 전)

전송 전에 다음 정보를 표시:
- 전체 노드 개수 및 타입별 분포
- 🔒 루트 노드 (변경 불가)
- 📄 일반 노드 (정리 대상)
- 🔍 **병합 가능한 유사 노드 쌍** (자동 감지)

**출력 예시**:
```
📊 BEFORE: 정리 전 분석
================================================================================
📝 총 text 노드: 11개
   - 🔒 루트 노드: 1개 (변경 불가)
   - 📄 일반 노드: 10개 (정리 대상)
🖼️  image/video 노드: 1개 (변경 없음)

🔍 병합 가능한 유사 노드 쌍:
--------------------------------------------------------------------------------
   ⚠️  [2] "UI 개선"
   ⚠️  [3] "사용자 경험 향상"
   → 같은 부모(#1), 유사 키워드 → 병합 추천

   ⚠️  [5] "성능 최적화"
   ⚠️  [7] "최적화 작업"
   → 같은 부모(#1), 유사 키워드 → 병합 추천
```

### Consumer (결과 수신 후)

결과를 받은 후 다음 정보를 표시:
- 정리된 노드 목록 (루트/일반/미디어 분리)
- 📊 **AFTER 통계**
- 🔍 **병합 분석** (누락된 nodeId = 병합된 노드)
- 💡 **감소율 계산**

**출력 예시**:
```
📊 AFTER: 정리 후 통계
================================================================================
   - 총 노드 개수: 6개
   - 🔒 루트 노드: 1개 (보호됨)
   - 📄 일반 text 노드: 4개 (정리됨)
   - 🖼️  image/video 노드: 1개 (변경 없음)

🔍 병합 분석 (누락된 nodeId = 병합되어 삭제된 노드):
--------------------------------------------------------------------------------
   ✅ 병합되어 제거된 nodeId: [3, 4, 6, 7, 9, 10]
   → 6개 노드가 다른 노드에 병합됨!

💡 예상 효과:
   - 병합 가능 대상: 일반 text 노드 4개
   - 실제 감소: 6개 노드 제거 (54.5% 감소)
   - 병합 성공! 🎉
```

---

## ✅ 검증 체크리스트

모든 시나리오에서 다음 항목을 확인하세요:

### 1. 루트 노드 보호
- [ ] parentId=null인 루트 노드의 keyword가 원본과 동일
- [ ] 루트 노드의 memo가 원본과 동일
- [ ] 루트 노드의 parentId가 여전히 null

### 2. 노드 병합
- [ ] 유사한 노드들이 실제로 통합되었는지
- [ ] 노드 개수가 20-50% 감소했는지
- [ ] 병합된 노드의 memo에 원본 내용이 포함되어 있는지

### 3. 언어 유지
- [ ] 한국어 노드가 영어로 번역되지 않았는지
- [ ] 영어 노드가 한국어로 번역되지 않았는지

### 4. 메타데이터 보존
- [ ] 모든 노드의 x, y 좌표가 보존되었는지
- [ ] 모든 노드의 color가 보존되었는지
- [ ] nodeId가 보존되었는지

### 5. 미디어 노드 보호
- [ ] image 노드가 변경되지 않았는지
- [ ] video 노드가 변경되지 않았는지

---

## 🎯 추천 테스트 순서

1. **시나리오 4번** (극단적 중복) - 가장 극적인 효과
2. **시나리오 5번** (영어) - 언어 유지 검증
3. **시나리오 1번** (대규모) - 실제 프로젝트 시뮬레이션
4. **시나리오 6번** (소규모) - 간단한 케이스
5. **시나리오 2번** (학습 계획) - 일반적인 사용 케이스
6. **시나리오 3번** (비즈니스) - 복잡한 구조

---

## 🔧 트러블슈팅

### 병합이 예상보다 적게 일어나는 경우

**원인**: LLM이 노드 간 유사성을 충분히 인식하지 못함

**해결 방법**:
1. Temperature 더 낮추기 (현재 0.1)
2. Few-shot 예시에 더 명확한 케이스 추가
3. 프롬프트에서 "MERGE" 키워드 강조

### 언어가 번역되는 경우

**원인**: LLM이 언어 유지 규칙을 놓침

**해결 방법**:
1. 시스템 프롬프트 최상단에 언어 규칙 배치
2. Few-shot 예시에 언어 유지 예시 추가
3. User 프롬프트에도 언어 유지 명시

### 루트 노드가 변경되는 경우

**원인**: LLM이 루트 노드를 변경함

**해결 방법**:
- 코드 레벨에서 자동 복원 (이미 구현됨)
- 서버 로그에서 "🔒 루트 노드" 경고 확인

---

## 📈 성능 벤치마크

| 시나리오 | 원본 노드 | 결과 노드 | 감소율 | 병합 품질 |
|---------|----------|----------|--------|----------|
| 1 (대규모) | 18 | 11 | 39% | ⭐⭐⭐⭐ |
| 2 (학습) | 9 | 6-7 | 22-33% | ⭐⭐⭐⭐ |
| 3 (비즈니스) | 13 | 10-11 | 15-23% | ⭐⭐⭐ |
| **4 (회의록)** | **11** | **5** | **54.5%** | **⭐⭐⭐⭐⭐** |
| 5 (영어) | 7 | 4-5 | 29-43% | ⭐⭐⭐⭐ |
| 6 (소규모) | 5 | 4 | 20% | ⭐⭐⭐ |

**평균 감소율**: **약 30-35%**

---

## 💡 Tips

1. **극적인 효과를 보고 싶다면**: 시나리오 4번 (54% 감소!)
2. **언어 유지를 검증하려면**: 시나리오 5번 (영어 전용)
3. **실제 사용 케이스**: 시나리오 1번 (복잡한 프로젝트)
4. **빠른 테스트**: 시나리오 6번 (6개 노드만)

---

## 📞 문의

테스트 중 이슈가 있으면 서버 로그를 확인하세요:
```bash
tail -100 nohup.out | grep "ORGANIZE"
```

또는:
```bash
tail -100 server.log | grep "ORGANIZE"
```
